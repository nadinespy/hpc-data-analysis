laude Code v2.1.7 ─────────────────────────────────────────────────────────────────────────────────────────────────╮
│                                                    │ Tips for getting started                                          │
│                Welcome back Nadine!                │ Run /init to create a CLAUDE.md file with instructions for Claude │
│                                                    │ ───────────────────────────────────────────────────────────────── │
│                       ▐▛███▜▌                      │ Recent activity                                                   │
│                      ▝▜█████▛▘                     │ No recent activity                                                │
│                        ▘▘ ▝▝                       │                                                                   │
│                                                    │                                                                   │
│      Opus 4.5 · Claude Pro ·                       │                                                                   │
│      nadine.spychala@gmail.com's Organization      │                                                                   │
│        ~/RSE/github_repos/hpc-data-analysis        │                                                                   │
╰────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

❯ Can you tell what seff.py does? In King's internal sysdocs documentation, it says: Seff.py script (06/25)¶                                                                        
                                                                                                                                                                                    
  This is a python script re-write of the perl seff command. The longterm aim of this script would be incorporation of a slurm epiloque to all job scripts to output                
  efficiency/utilisation of provisioned resources. The script has seen limited testing with members of Micaela Matta's Chemistry group but also Julia El-Sayed Moustafa's group.    
  When evoked as a python script on the command line, you may expect something like below:                                                                                          
                                                                                                                                                                                    
  k2372240@erc-hpc-login1:~$ ./seff.py 25852190                                                                                                                                     
  Job ID: 25852190                                                                                                                                                                  
  User: k2372240                                                                                                                                                                    
  State: TIMEOUT                                                                                                                                                                    
  Elapsed time: 00:01:02                                                                                                                                                            
  CPU Efficiency: 96.9% of 1 core(s) used                                                                                                                                           
  Memory Efficiency: 73.6% of 2048 MB used                                                                                                                                          

● Search(pattern: "**/seff.py")
  ⎿  Found 1 file (ctrl+o to expand)

● Read(seff.py)
  ⎿  Read 141 lines

● What seff.py Does

  seff.py is a Python script that reports resource efficiency statistics for completed Slurm jobs. It's a Python rewrite of the original Perl seff command.

  Core Functionality

  1. Takes a job ID as input (line 57-61)
  2. Queries Slurm's accounting database using sacct to retrieve job information (line 64-65)
  3. Calculates and displays two key efficiency metrics:
    - CPU Efficiency: (TotalCPU time / (Elapsed time × AllocCPUs)) × 100
    - Memory Efficiency: (MaxRSS / Requested Memory) × 100

  Key Components
  ┌──────────────┬──────────────────────────────────────────────────────────┐
  │   Function   │                         Purpose                          │
  ├──────────────┼──────────────────────────────────────────────────────────┤
  │ run_cmd()    │ Executes shell commands and handles errors               │
  ├──────────────┼──────────────────────────────────────────────────────────┤
  │ parse_mem()  │ Converts memory strings (K/M/G/T suffixes) to MB         │
  ├──────────────┼──────────────────────────────────────────────────────────┤
  │ parse_time() │ Converts time strings (including days format) to seconds │
  ├──────────────┼──────────────────────────────────────────────────────────┤
  │ main()       │ Orchestrates the job lookup and efficiency calculation   │
  └──────────────┴──────────────────────────────────────────────────────────┘
  Fields Retrieved from sacct

  - JobID, User, State, Elapsed time, TotalCPU, MaxRSS (max memory), AllocCPUs, ReqMem

  Output Handling

  - For completed jobs: Shows CPU and memory efficiency percentages
  - For running/pending jobs: Notes that resource data isn't available yet
  - For jobs with missing accounting data: Displays a warning message

  The script is useful for users to understand if they're over-provisioning resources (e.g., requesting 8 cores but only using 1, or requesting 64GB RAM but only using 2GB), which helps optimize cluster utilization.

❯ Alright, now look at faculty_stats.py - this calculates faculty-level (or whatever level one chooses) stats. Can you say in more detail what it does? 

● Read(faculty_stats.py)
  ⎿  Read 114 lines

● What faculty_stats.py Does

  This script aggregates HPC job statistics by faculty/organizational unit for a specified date range. It combines data from two sources: Slurm's MySQL accounting database and Active Directory (LDAP) for user-to-faculty mapping.

  Data Flow

  Slurm MySQL DB ──► Job data (user, CPUs, memory, time, nodes)
                            │
                            ▼
  LDAP/AD ──────────► Faculty lookup for each username
                            │
                            ▼
                     Aggregate stats by faculty
                            │
                            ▼
                     CSV output

  Configuration

  - Date range: Hardcoded at lines 8-9 (START_DATE, END_DATE)
  - LDAP config: Loaded from /etc/hpc_export_stats.yaml
  - MySQL credentials: Hardcoded connection to ermysqlr2.er.kcl.ac.uk

  Step-by-Step Breakdown
  ┌─────────────────────┬─────────┬────────────────────────────────────────────────────────────────────────────────────┐
  │        Step         │  Lines  │                                    Description                                     │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 1. MySQL connection │ 17-23   │ Connects to Slurm accounting database                                              │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 2. LDAP connection  │ 27-30   │ Connects to Active Directory with TLS                                              │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 3. Query jobs       │ 57-68   │ Fetches all jobs within date range that have valid start/end times                 │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 4. Faculty lookup   │ 35-53   │ For each username, queries LDAP for the st attribute (state/faculty), with caching │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 5. Aggregation      │ 76-98   │ Accumulates per-faculty totals for jobs, elapsed time, CPUs, memory, nodes         │
  ├─────────────────────┼─────────┼────────────────────────────────────────────────────────────────────────────────────┤
  │ 6. Output           │ 106-108 │ Prints CSV sorted by job count (descending)                                        │
  └─────────────────────┴─────────┴────────────────────────────────────────────────────────────────────────────────────┘
  SQL Query Details (lines 57-68)

  Retrieves from Slurm's tables:
  - user - username (via association table join)
  - cpus_req - CPUs requested
  - mem_req - memory requested (bytes)
  - time_start, time_end - job timestamps
  - nodes_alloc - nodes allocated
  - state - job state (though not used in aggregation)

  Filters: Only jobs with valid start/end times within the date range.

  Output Format

  faculty,job_count,total_elapsed_seconds,total_cpus_requested,total_mem_bytes,total_nodes
  "Faculty of Science",15234,892341234,45678,12345678901234,1234
  "Faculty of Arts",8921,...

  Notes

  - The st LDAP attribute is used to determine faculty - this is a custom attribute mapping in King's AD
  - Faculty lookup results are cached (faculty_cache) to avoid repeated LDAP queries for the same user
  - Users not found in LDAP are assigned to "unknown" faculty
  - Progress messages go to stderr, CSV output to stdout

❯ Alright, can we combine the two such that we get job-level stats ordered by faculty? Would be also good to get global stats independent of faculty. Building a dataset with all   
  needed info will probably necessary. What do you think? Do a back and forth with me.                                                                                              

● Good idea to discuss this before diving in. Here's my initial thinking:

  What we'd need to combine
  ┌─────────────────────────────────────────┬──────────────────────────────┐
  │              From seff.py               │    From faculty_stats.py     │
  ├─────────────────────────────────────────┼──────────────────────────────┤
  │ CPU efficiency (actual vs allocated)    │ Faculty lookup via LDAP      │
  ├─────────────────────────────────────────┼──────────────────────────────┤
  │ Memory efficiency (MaxRSS vs requested) │ Date range filtering         │
  ├─────────────────────────────────────────┼──────────────────────────────┤
  │ Job state handling                      │ MySQL connection to Slurm DB │
  └─────────────────────────────────────────┴──────────────────────────────┘
  Key question: Where does usage data live?

  seff.py gets actual usage (TotalCPU, MaxRSS) via the sacct command. faculty_stats.py queries MySQL but only pulls requested resources (cpus_req, mem_req), not actual consumption.

  To calculate efficiency at scale, we need to know:
  1. Does the Slurm MySQL database contain actual usage data (like TotalCPU, MaxRSS)? Or is that only available via sacct?
  2. If it's only in sacct, calling it per-job would be very slow for thousands of jobs.

  Proposed output structure

  I'm imagining two levels:

  Job-level dataset:
  job_id, user, faculty, state, elapsed, cpus_req, cpus_used, cpu_eff%, mem_req, mem_used, mem_eff%

  Aggregated stats (per-faculty and global):
  - Total jobs, total core-hours, average CPU efficiency, average memory efficiency
  - Maybe distributions (e.g., % of jobs with <50% CPU efficiency)

  Questions for you

  1. Is the actual usage data (TotalCPU, MaxRSS) available in the MySQL database, or only through sacct?
  2. What's the scale - how many jobs are we talking about for a typical query?
  3. For "global stats" - what metrics matter most? Averages, medians, distributions?
  4. Output format preference - CSV, or something else?

❯ This is one possible output from faculty_stats.py: Statistics collated by faculty:                                                                                                
  faculty,Job Count,Total Elapsed (s),Total CPU (s),Total Max RSS (bytes),Total Req Mem (bytes),Total Alloc CPUs                                                                    
  "Institute of Psychiatry, Psychology & Neuroscience",1443,1975601014.0,573907.0,1319430877314,10182696370238,3246                                                                 
  "Faculty of Life Sciences & Medicine",9555,1253081317.0,11753444.0,138890314120069,48599140401152,15479                                                                           
  "Faculty of Natural, Mathematical & Engineering Sciences",21162,16706487494.0,496813395.0,85636588025347,3215016177173472,67957                                                   
  "Faculty of Life Sciences and Medicine",1432,2182792568.0,28581104.0,6881694604883,11362101101040,1557                                                                            
  "Faculty of Dentistry, Oral & Craniofacial Sciences",204,5159202.0,68599904.0,636375191552,37196111282176,11626                                                                   
  "unknown",3020,33017294.0,5830268.0,61557181123531,28950201895096,29306                                                                                                           
  "IoPPN",102198,40105675.0,75246261.0,316664197181130,603168213827584,205524                                                                                                       
  "IT",11,294141.0,160293.0,110936469504,687194767360,36                                                                                                                            
  "Dentistry, Oral & Craniofacial Sciences",18,246998.0,50194.0,984851939328,1097364144128,59                                                                                       
  "Research Management & Innovation",40,43507.0,10890.0,38017523712,92039806976,100                                                                                                 
  "King's Business School",4,28835.0,21829.0,800467980288,549755813888,2                                                                                                            
  "King's Education",8,99058.0,0.0,975904768,53687091200,21                                                                                                                         
  It's HPC stats for one week in January 2025. I'm not quite sure what all of these variables mean: faculty,Job Count,Total Elapsed (s),Total CPU (s),Total Max RSS (bytes),Total   
  Req Mem (bytes),Total Alloc CPUs. Can you tell? And are there maybe other variables we could get from sacct? The variables aggregated per faculty are just a selection of what    
  could possibly be queried. Actually, actual CPU usage likely won't be available in sacct data as such, otherwise seff.py would have not been written (it's purpose is to provide  
  job efficiency of jobs).                                                                                                                                                          

● Good question. Let me break down what these variables likely mean:

  Variable Definitions
  ┌───────────────────────┬─────────────────────────────────────────────────┬──────────────────────┐
  │       Variable        │                     Meaning                     │        Source        │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Job Count             │ Number of jobs submitted                        │ Count of job records │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Total Elapsed (s)     │ Sum of wall-clock time (time_end - time_start)  │ How long jobs ran    │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Total CPU (s)         │ Sum of TotalCPU - actual CPU seconds consumed   │ This IS actual usage │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Total Max RSS (bytes) │ Sum of MaxRSS - actual peak memory used per job │ This IS actual usage │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Total Req Mem (bytes) │ Sum of memory requested when submitting jobs    │ What users asked for │
  ├───────────────────────┼─────────────────────────────────────────────────┼──────────────────────┤
  │ Total Alloc CPUs      │ Sum of CPUs allocated to jobs                   │ What was provisioned │
  └───────────────────────┴─────────────────────────────────────────────────┴──────────────────────┘
  Wait - the output you showed has more columns than the code I read

  The faculty_stats.py I read only queries cpus_req, mem_req, time_start, time_end, nodes_alloc, state. But your output includes Total CPU (s) and Total Max RSS which are actual usage metrics.

  So either:
  1. There's a modified version of the script, or
  2. The Slurm MySQL database does contain actual usage data (TotalCPU, MaxRSS)

  Clarification on seff.py

  Actually, seff.py does get actual usage from sacct - it retrieves TotalCPU and MaxRSS. What seff.py calculates is the efficiency ratio:

  CPU Efficiency = TotalCPU / (Elapsed × AllocCPUs) × 100
  Memory Efficiency = MaxRSS / ReqMem × 100

  The raw data exists; seff.py just does the math and presents it nicely.

  Other useful sacct variables

  Here are some potentially interesting fields we could pull:
  ┌────────────────────┬───────────────────────────────────────────────────────┐
  │       Field        │                      Description                      │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ UserCPU, SystemCPU │ Breakdown of CPU time (user vs kernel)                │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ MaxVMSize          │ Peak virtual memory (vs RSS which is physical)        │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ AveCPU, AveRSS     │ Average values across job steps                       │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ ExitCode           │ How the job ended (useful for failure analysis)       │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ Timelimit          │ Requested time limit (for time efficiency)            │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ Partition, QOS     │ Which queue/priority was used                         │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ Submit, Start, End │ Full timestamp breakdown (wait time = Start - Submit) │
  ├────────────────────┼───────────────────────────────────────────────────────┤
  │ NNodes, NTasks     │ Parallelization details                               │
  └────────────────────┴───────────────────────────────────────────────────────┘
  Key question back to you

  Can you check what tables/columns exist in the Slurm MySQL database? If TotalCPU and MaxRSS are there, we can build the full dataset directly from MySQL (fast). If not, we'd need to call sacct per job (slow) or find another approach.

  What's the actual data source for the output you showed?

❯ faculty_stats.py queries the slurm accounting database and LDAP. seff.py queries only the slurm accounting database. Re Total CPU (s) and Total Max RSS, yeah that data was       
  calculated using __init__.py (have a look at this), I wrote faculty_stats.py based on this to be able to query a MySQL database using Python's MySQL connector library. Seems I   
  haven't used all original variables. Regarding the additional fields you suggest - not entirely clear to me how they help/are interesting. Could you explain? Re the columns,     
  you'd at least see via __init__.py that it's possible to get TotalCPU and MaxRSS. Could we use the same calculation as in seff.py, rather than use seff.py to compute job         
  efficiency? Looks like it could be an addition of just a few lines. Or should we call seff.py in faculty_stats.py? Please all points/questions I raise here.                      

● Search(pattern: "**/__init__.py")
  ⎿  Found 1 file (ctrl+o to expand)

● Read(__init__.py)
  ⎿  Read 180 lines

● Now I understand the full picture. Let me address all your points:

  1. How init.py differs from faculty_stats.py
  ┌─────────────┬──────────────────────────────────────────────────────────────────┬───────────────────────────────────┐
  │   Aspect    │                             init.py                              │         faculty_stats.py          │
  ├─────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────────┤
  │ Data source │ sacct command (line 121-133)                                     │ MySQL directly                    │
  ├─────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────────┤
  │ Variables   │ JobID, User, State, Elapsed, TotalCPU, MaxRSS, AllocCPUs, ReqMem │ Subset (missing TotalCPU, MaxRSS) │
  ├─────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────────┤
  │ Flexibility │ Generic --collate_by argument                                    │ Hardcoded to faculty              │
  └─────────────┴──────────────────────────────────────────────────────────────────┴───────────────────────────────────┘
  So yes, TotalCPU and MaxRSS are available via sacct - __init__.py already gets them.

  2. Inline calculation vs calling seff.py

  Definitely inline the calculation. The efficiency formulas are trivial:

  cpu_eff = (totalcpu_sec / (elapsed_sec * alloccpus)) * 100 if (elapsed_sec > 0 and alloccpus > 0) else 0
  mem_eff = (maxrss / reqmem) * 100 if reqmem > 0 else 0

  Calling seff.py per job would mean spawning a subprocess for each job - extremely slow for thousands of jobs. The calculation is just division; no reason to call external code.

  3. Re: the additional sacct fields I suggested

  You're right to push back. Let me be more concrete about which are actually useful:

  Potentially useful:
  ┌───────────────┬────────────────────────────────────────────────────────────────────────┐
  │     Field     │                          Why it could matter                           │
  ├───────────────┼────────────────────────────────────────────────────────────────────────┤
  │ Timelimit     │ Time efficiency: elapsed / timelimit - are users over-requesting time? │
  ├───────────────┼────────────────────────────────────────────────────────────────────────┤
  │ Submit, Start │ Wait time: start - submit - shows queue pressure per faculty           │
  ├───────────────┼────────────────────────────────────────────────────────────────────────┤
  │ ExitCode      │ Failure rate analysis - which faculties have jobs failing most?        │
  └───────────────┴────────────────────────────────────────────────────────────────────────┘
  Probably not useful for your goal:
  - UserCPU/SystemCPU - too granular, TotalCPU suffices
  - MaxVMSize - RSS is the meaningful memory metric
  - Partition/QOS - tangential to faculty-level analysis

  So really just Timelimit (for time efficiency) and wait time (queue experience) seem worth adding. The rest was me over-suggesting.

  4. Next steps - your call

  We could:

  Option A: Extend __init__.py to add efficiency calculations and output job-level data (it already has the right data)

  Option B: Extend faculty_stats.py to use sacct instead of MySQL (to get TotalCPU/MaxRSS)

  Option C: Build something new that outputs both job-level CSV and aggregated stats

  Which direction appeals to you? And do you want time efficiency (elapsed vs timelimit) and wait time included?

✻ Cogitated for 32s

❯ "Calling seff.py per job would mean spawning a subprocess for each job" - why is this happening (spawning a subprocess for each job)? We have to MySQL, as pulling data via sacct 
  turned out very unreliable. That was the whole reason I pivoted to the MySQL connector library after replication target (i.e., a replication of the slurm accounting database)    
  was created for me. Let's not hardcode to faculty, but have a collate-by parameter, as in the original script (__init__.py). Let's do the efficiency calculation in the same      
  script and not call seff.py. Let's add all three fields (TimeLimit, Submit/Start, ExitCode) into our analysis. Let's have as an output the same variables as in the output sample 
  I've shown you (coming from the original __init__.py) plus the other three fields you suggested, using an aggregation parameter (--collate_by) which we extend to include None,   
  in which case stats will be presented independent of an aggregation parameter, just across all jobs. The command for running __init__.py was srun hpc_export_stats --collate_by   
  st=faculty --since 2025-11-02 --until 2025-11-03, just for you to see an example. Is all clear? Ask questions, if not. Did I miss something? Point to caveats, things to          
  consider, if anything comes to your mind.                                                                                                                                         

● Ah, I see the confusion. I wasn't saying we should call seff.py - I was explaining why we shouldn't. We're aligned: inline the calculation, use MySQL, no subprocess calls.

  Let me confirm my understanding and raise some questions:

  My understanding

  1. Data source: MySQL (not sacct) - reliability issue solved
  2. Collate-by parameter: Flexible like __init__.py, e.g. --collate_by st=faculty
  3. Extend collate-by: Allow --collate_by none for global stats (no grouping)
  4. Efficiency: Calculate inline using seff.py's formula
  5. New fields: Timelimit, Submit/Start (wait time), ExitCode

  Questions

  1. MySQL schema - do these columns exist?

  faculty_stats.py queries create_job_table. I need to know if these fields are available:
  - TotalCPU (or equivalent for actual CPU usage)
  - MaxRSS (actual memory used)
  - Timelimit (requested time)
  - time_submit (for wait time calculation)
  - exit_code or similar

  Could you confirm which of these exist in the MySQL tables, or should I assume the schema mirrors what sacct provides?

  2. Efficiency at aggregate level

  When aggregating by faculty, how should we calculate efficiency?
  - Option A (weighted): Sum(TotalCPU) / Sum(Elapsed × AllocCPUs) - larger jobs count more
  - Option B (simple average): Average(per-job CPU efficiency) - each job counts equally

  Option A is probably more meaningful for resource utilization analysis. Your preference?

  3. Wait time representation

  For Submit → Start wait time, should we output:
  - Total wait seconds (sum)?
  - Average wait time?
  - Both?

  4. ExitCode - how to aggregate?

  Should this be:
  - Count of non-zero exit codes (failures)?
  - Breakdown by exit code value?
  - Just include in job-level output but not aggregate?

  5. Job-level output too?

  You initially mentioned "job-level stats ordered by faculty". Do you want:
  - Just aggregated output (like current __init__.py), or
  - Also a job-level CSV with every individual job's stats?

  Caveats to consider

  1. Division by zero: Jobs with 0 elapsed time or 0 allocated CPUs - need guards
  2. NULL/missing values: Some jobs may have NULL for TotalCPU, MaxRSS, etc. - how to handle?
  3. Job steps: __init__.py handles top-level jobs vs steps differently (MaxRSS comes from steps). Does the MySQL schema separate these, or is it pre-aggregated per job?

❯ Re MySQL Schema: I once wrote down this from previous explorations: "Figured out the DB schema (at least in part): The main table for jobs is create_job_table, but it only has   
  numeric IDs for users (id_user). To get the username (like k2472719) which we need to query LDAP, you join it with create_assoc_table using the id_assoc column they share." I    
  suppose the schema mirrors what sacct provides? Re efficiency: can you elaborate on what you mean? What do you mean by "larger" jobs? Also regarding 3, can you explain? Also 4,  
  please explain what each option means. Re 5, with ""job-level stats ordered by faculty", I mean the same output as in __init__py, but with the option to have global stats as     
  well. I wonder if it's useful to save individual job-level data (including the efficiency) in a database. What do you mean by caveat #3? And yes, let's handle the division by    
  zero case, and put NULL for cases where a calculation/data extraction is not possible.                                                                                            

● Let me elaborate on each point with concrete examples:

  Efficiency calculation - what I meant by "larger jobs"

  Say you have 2 jobs in a faculty:
  ┌─────┬──────────┬─────────┬───────────┬────────────────┐
  │ Job │ TotalCPU │ Elapsed │ AllocCPUs │ CPU Efficiency │
  ├─────┼──────────┼─────────┼───────────┼────────────────┤
  │ A   │ 90s      │ 100s    │ 1         │ 90%            │
  ├─────┼──────────┼─────────┼───────────┼────────────────┤
  │ B   │ 1800s    │ 10000s  │ 2         │ 9%             │
  └─────┴──────────┴─────────┴───────────┴────────────────┘
  Option A (weighted):
  Sum(TotalCPU) / Sum(Elapsed × AllocCPUs)
  = (90 + 1800) / (100×1 + 10000×2)
  = 1890 / 20100
  = 9.4%
  Job B dominates because it used far more resources (20,000 CPU-seconds allocated vs 100).

  Option B (simple average):
  (90% + 9%) / 2 = 49.5%
  Each job counts equally regardless of size.

  Which is better? Depends on the question:
  - "How efficiently are our CPU resources being used?" → Option A (weighted)
  - "What's the typical job efficiency?" → Option B (simple average)

  For resource utilization reporting, Option A is usually more meaningful.

  Wait time (point 3)

  Wait time = time_start - time_submit (how long a job sat in the queue)
  ┌─────┬───────────┐
  │ Job │ Wait time │
  ├─────┼───────────┤
  │ A   │ 60s       │
  ├─────┼───────────┤
  │ B   │ 300s      │
  ├─────┼───────────┤
  │ C   │ 120s      │
  └─────┴───────────┘
  - Total wait: 60 + 300 + 120 = 480s (sum of all waiting)
  - Average wait: 480 / 3 = 160s (typical queue experience)

  Average is probably more useful - it tells you "on average, how long do jobs from this faculty wait in queue?"

  ExitCode (point 4)

  Exit codes indicate how jobs ended. Common values:
  - 0 = success
  - 1, 2, etc. = various failures
  - Signal codes like 9 (killed), 15 (terminated)

  Aggregation options:
  ┌───────────────────┬───────────────────────────────────────┬───────────────────────────────────┐
  │      Option       │            Output example             │             Use case              │
  ├───────────────────┼───────────────────────────────────────┼───────────────────────────────────┤
  │ Count of failures │ failed_jobs: 23                       │ Simple "how many jobs failed?"    │
  ├───────────────────┼───────────────────────────────────────┼───────────────────────────────────┤
  │ Breakdown by code │ exit_0: 150, exit_1: 20, exit_9: 3    │ Understand failure patterns       │
  ├───────────────────┼───────────────────────────────────────┼───────────────────────────────────┤
  │ Job-level only    │ Don't aggregate, just include per-job │ Keep it simple at aggregate level │
  └───────────────────┴───────────────────────────────────────┴───────────────────────────────────┘
  I'd suggest: Count of successful (exit=0) vs failed (exit≠0) at the aggregate level. Simple and actionable.

  Caveat #3 - Job steps explained

  In Slurm, a single job (e.g., 12345) can have multiple steps:
  12345         (main job record - has Elapsed, ReqMem, AllocCPUs)
  12345.batch   (batch step - has MaxRSS, TotalCPU)
  12345.0       (job step 0)

  __init__.py handles this at lines 142-155:
  - Main job (job == jobid): Gets Elapsed, ReqMem, AllocCPUs
  - Steps (.batch, .0, etc.): Gets MaxRSS

  The question: In the MySQL table, is this pre-flattened (one row per job with all data), or are there separate rows for steps? If separate, we need to join/aggregate them.

  Storing individual job data

  I wonder if it's useful to save individual job-level data (including the efficiency) in a database.

  This could be valuable for:
  - Historical trend analysis (efficiency over time)
  - Identifying specific inefficient jobs to follow up on
  - Per-user analysis within faculties
  - Debugging/auditing

  Trade-off: More storage, more complexity. But if the data is already in Slurm's DB, you could query on-demand rather than duplicating it. A "materialized view" with efficiency pre-calculated might be a middle ground.

  Worth doing? Depends on whether you'll actually use it. Start with the aggregated output; add job-level export later if needed?

  Summary of decisions needed
  ┌────────────────────────┬───────────────────────────────────────────┐
  │        Question        │               My suggestion               │
  ├────────────────────────┼───────────────────────────────────────────┤
  │ Efficiency aggregation │ Option A (weighted)                       │
  ├────────────────────────┼───────────────────────────────────────────┤
  │ Wait time              │ Average wait time                         │
  ├────────────────────────┼───────────────────────────────────────────┤
  │ ExitCode               │ Count success vs failed                   │
  ├────────────────────────┼───────────────────────────────────────────┤
  │ Job-level storage      │ Defer for now, focus on aggregated output │
  ├────────────────────────┼───────────────────────────────────────────┤
  │ MySQL schema           │ Verify column names exist before coding   │
  └────────────────────────┴───────────────────────────────────────────┘
  Do these suggestions work for you? And should I check the MySQL schema somehow, or do you have access to verify what columns exist in create_job_table?

✻ Cooked for 30s

❯ I think I don't understand your weighted job efficiency calculation. What's the reasoning behind Sum(TotalCPU) / Sum(Elapsed × AllocCPUs) being a weighted job efficiency         
  calculation? In general, why not include both (how efficient jobs are, and what the typical job efficiency is)? Regarding wait time, why not include both, too? Re exit codes,    
  I'd use both a failed/did not fail column, as well as store the exact failure code (and count them per faculty or globally). Re job steps, this is a snippet from an output I get 
  when running sacct -nPo JobID,User,State,Elapsed,TotalCPU,MaxRSS,AllocCPUs,ReqMem   --starttime=2025-01-01   --endtime=2025-01-31   --allusers | tr '|' ',' >>                    
  job_outputs/jobs_january2025.csv:  18462297_100,k20044695,RUNNING,501-19:22:58,00:00:00,,1,100000M                                                                                
  18462297_100.batch,,RUNNING,501-19:22:58,00:00:00,,1, Re individual job data, alright, let's not store this for now. I wonder, the scripts probably make sure, only completed     
  jobs are counted in, right? It otherwise wouldn't be possible to calculate the stats. Re verifying the column names in MySQL, I mean if faculty_stats.py gave us most of the data 
  we wanted, I assume the variables will be the same as in the slurm accounting data?                                                                                               

● Weighted efficiency - the reasoning

  Think of it as "total resource utilization":

  Weighted CPU Efficiency = Total CPU time actually used / Total CPU time allocated

  If Faculty A runs jobs that collectively were allocated 1,000,000 CPU-seconds and actually used 400,000 CPU-seconds, their efficiency is 40%. This tells you: "40% of the CPU resources given to this faculty were actually used."

  The formula Sum(TotalCPU) / Sum(Elapsed × AllocCPUs) works because:
  - Elapsed × AllocCPUs = CPU-seconds allocated to that job
  - TotalCPU = CPU-seconds actually consumed
  - Summing both gives total allocated vs total used

  It's "weighted" because a job using 10,000 CPU-seconds contributes more to the calculation than a job using 10 CPU-seconds. Each CPU-second counts equally, rather than each job counting equally.

  Include both - agreed

  You're right, let's include both:
  ┌────────────────────────┬───────────────────────────────────────────────────────────┐
  │         Metric         │                      What it answers                      │
  ├────────────────────────┼───────────────────────────────────────────────────────────┤
  │ Weighted efficiency    │ "How efficiently are allocated resources being used?"     │
  ├────────────────────────┼───────────────────────────────────────────────────────────┤
  │ Average job efficiency │ "What's the typical job's efficiency?"                    │
  ├────────────────────────┼───────────────────────────────────────────────────────────┤
  │ Total wait time        │ "How much total queue time is this faculty experiencing?" │
  ├────────────────────────┼───────────────────────────────────────────────────────────┤
  │ Average wait time      │ "What's the typical queue experience?"                    │
  └────────────────────────┴───────────────────────────────────────────────────────────┘
  Job steps - your example

  Your output shows:
  18462297_100,k20044695,RUNNING,501-19:22:58,00:00:00,,1,100000M
  18462297_100.batch,,RUNNING,501-19:22:58,00:00:00,,1,

  The main job has User, ReqMem. The .batch step would have MaxRSS (empty here because it's still RUNNING). This matches what __init__.py does - it takes different fields from different rows.

  For MySQL: We need to check if the table has one row per job (pre-aggregated) or separate rows for steps. If it's like sacct output, we'll need similar logic.

  Completed jobs only

  Looking at the code:

  - faculty_stats.py filters: j.time_start > 0 AND j.time_end > 0 - so yes, only completed jobs
  - __init__.py does NOT explicitly filter - it processes everything sacct returns, including RUNNING jobs (like your example)

  For efficiency calculations, we should filter for completed jobs only (jobs where state is COMPLETED, FAILED, TIMEOUT, etc., and time_end > 0). Running jobs don't have final TotalCPU/MaxRSS values.

  Should we also include FAILED/TIMEOUT jobs in efficiency stats, or only COMPLETED? They did consume resources, so probably yes - but worth confirming.

  MySQL columns

  You're right that the basic columns work. The question is specifically about:
  ┌───────────┬──────────┬─────────────────────────────────────────────────────┐
  │   Field   │ In sacct │                      In MySQL?                      │
  ├───────────┼──────────┼─────────────────────────────────────────────────────┤
  │ TotalCPU  │ Yes      │ Need to verify column name                          │
  ├───────────┼──────────┼─────────────────────────────────────────────────────┤
  │ MaxRSS    │ Yes      │ Need to verify - might be in a separate step table? │
  ├───────────┼──────────┼─────────────────────────────────────────────────────┤
  │ Timelimit │ Yes      │ Need to verify column name                          │
  ├───────────┼──────────┼─────────────────────────────────────────────────────┤
  │ exit_code │ Yes      │ Need to verify column name                          │
  └───────────┴──────────┴─────────────────────────────────────────────────────┘
  Could you run a quick query to check what columns exist?
  DESCRIBE create_job_table;

  Or do you have documentation on the schema? If not, I can make reasonable guesses based on Slurm's typical schema and we can adjust if queries fail.

❯ This is what I once got when checking all tables/variables: === TABLES ===                                                                                                        
  acct_coord_table                                                                                                                                                                  
  acct_table                                                                                                                                                                        
  clus_res_table                                                                                                                                                                    
  cluster_table                                                                                                                                                                     
  convert_version_table                                                                                                                                                             
  create_assoc_table                                                                                                                                                                
  create_assoc_usage_day_table                                                                                                                                                      
  create_assoc_usage_hour_table                                                                                                                                                     
  create_assoc_usage_month_table                                                                                                                                                    
  create_event_table                                                                                                                                                                
  create_job_env_table                                                                                                                                                              
  create_job_script_table                                                                                                                                                           
  create_job_table                                                                                                                                                                  
  create_last_ran_table                                                                                                                                                             
  create_qos_usage_day_table                                                                                                                                                        
  create_qos_usage_hour_table                                                                                                                                                       
  create_qos_usage_month_table                                                                                                                                                      
  create_resv_table                                                                                                                                                                 
  create_step_table                                                                                                                                                                 
  create_suspend_table                                                                                                                                                              
  create_usage_day_table                                                                                                                                                            
  create_usage_hour_table                                                                                                                                                           
  create_usage_month_table                                                                                                                                                          
  create_wckey_table                                                                                                                                                                
  create_wckey_usage_day_table                                                                                                                                                      
  create_wckey_usage_hour_table                                                                                                                                                     
  create_wckey_usage_month_table                                                                                                                                                    
  federation_table                                                                                                                                                                  
  qos_table                                                                                                                                                                         
  res_table                                                                                                                                                                         
  table_defs_table                                                                                                                                                                  
  tres_table                                                                                                                                                                        
  txn_table                                                                                                                                                                         
  user_table                                                                                                                                                                        
                                                                                                                                                                                    
  === acct_coord_table ===                                                                                                                                                          
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  acct                           tinytext                                                                                                                                           
  user                           tinytext                                                                                                                                           
                                                                                                                                                                                    
  === acct_table ===                                                                                                                                                                
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  flags                          int(10) unsigned                                                                                                                                   
  name                           tinytext                                                                                                                                           
  description                    text                                                                                                                                               
  organization                   text                                                                                                                                               
                                                                                                                                                                                    
  === clus_res_table ===                                                                                                                                                            
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  cluster                        tinytext                                                                                                                                           
  res_id                         int(11)                                                                                                                                            
  allowed                        int(10) unsigned                                                                                                                                   
                                                                                                                                                                                    
  === cluster_table ===                                                                                                                                                             
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  name                           tinytext                                                                                                                                           
  id                             smallint(6)                                                                                                                                        
  control_host                   tinytext                                                                                                                                           
  control_port                   int(10) unsigned                                                                                                                                   
  last_port                      int(10) unsigned                                                                                                                                   
  rpc_version                    smallint(5) unsigned                                                                                                                               
  classification                 smallint(5) unsigned                                                                                                                               
  dimensions                     smallint(5) unsigned                                                                                                                               
  flags                          int(10) unsigned                                                                                                                                   
  federation                     tinytext                                                                                                                                           
  features                       text                                                                                                                                               
  fed_id                         int(10) unsigned                                                                                                                                   
  fed_state                      smallint(5) unsigned                                                                                                                               
                                                                                                                                                                                    
  === convert_version_table ===                                                                                                                                                     
  mod_time                       bigint(20) unsigned                                                                                                                                
  version                        int(11)                                                                                                                                            
                                                                                                                                                                                    
  === create_assoc_table ===                                                                                                                                                        
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  comment                        text                                                                                                                                               
  flags                          int(10) unsigned                                                                                                                                   
  is_def                         tinyint(4)                                                                                                                                         
  id_assoc                       int(10) unsigned                                                                                                                                   
  user                           tinytext                                                                                                                                           
  acct                           tinytext                                                                                                                                           
  partition                      tinytext                                                                                                                                           
  parent_acct                    tinytext                                                                                                                                           
  id_parent                      int(10) unsigned                                                                                                                                   
  lineage                        text                                                                                                                                               
  shares                         int(11)                                                                                                                                            
  max_jobs                       int(11)                                                                                                                                            
  max_jobs_accrue                int(11)                                                                                                                                            
  min_prio_thresh                int(11)                                                                                                                                            
  max_submit_jobs                int(11)                                                                                                                                            
  max_tres_pj                    text                                                                                                                                               
  max_tres_pn                    text                                                                                                                                               
  max_tres_mins_pj               text                                                                                                                                               
  max_tres_run_mins              text                                                                                                                                               
  max_wall_pj                    int(11)                                                                                                                                            
  grp_jobs                       int(11)                                                                                                                                            
  grp_jobs_accrue                int(11)                                                                                                                                            
  grp_submit_jobs                int(11)                                                                                                                                            
  grp_tres                       text                                                                                                                                               
  grp_tres_mins                  text                                                                                                                                               
  grp_tres_run_mins              text                                                                                                                                               
  grp_wall                       int(11)                                                                                                                                            
  priority                       int(10) unsigned                                                                                                                                   
  def_qos_id                     int(11)                                                                                                                                            
  qos                            blob                                                                                                                                               
  delta_qos                      blob                                                                                                                                               
                                                                                                                                                                                    
  === create_assoc_usage_day_table ===                                                                                                                                              
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_assoc_usage_hour_table ===                                                                                                                                             
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_assoc_usage_month_table ===                                                                                                                                            
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_event_table ===                                                                                                                                                        
  deleted                        tinyint(4)                                                                                                                                         
  time_start                     bigint(20) unsigned                                                                                                                                
  time_end                       bigint(20) unsigned                                                                                                                                
  node_name                      tinytext                                                                                                                                           
  extra                          text                                                                                                                                               
  cluster_nodes                  text                                                                                                                                               
  instance_id                    text                                                                                                                                               
  instance_type                  text                                                                                                                                               
  reason                         tinytext                                                                                                                                           
  reason_uid                     int(10) unsigned                                                                                                                                   
  state                          int(10) unsigned                                                                                                                                   
  tres                           text                                                                                                                                               
                                                                                                                                                                                    
  === create_job_env_table ===                                                                                                                                                      
  deleted                        tinyint(4)                                                                                                                                         
  hash_inx                       bigint(20) unsigned                                                                                                                                
  last_used                      timestamp                                                                                                                                          
  env_hash                       text                                                                                                                                               
  env_vars                       longtext                                                                                                                                           
                                                                                                                                                                                    
  === create_job_script_table ===                                                                                                                                                   
  deleted                        tinyint(4)                                                                                                                                         
  hash_inx                       bigint(20) unsigned                                                                                                                                
  last_used                      timestamp                                                                                                                                          
  script_hash                    text                                                                                                                                               
  batch_script                   longtext                                                                                                                                           
                                                                                                                                                                                    
  === create_job_table ===                                                                                                                                                          
  job_db_inx                     bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  account                        tinytext                                                                                                                                           
  admin_comment                  text                                                                                                                                               
  array_task_str                 text                                                                                                                                               
  array_max_tasks                int(10) unsigned                                                                                                                                   
  array_task_pending             int(10) unsigned                                                                                                                                   
  constraints                    text                                                                                                                                               
  container                      text                                                                                                                                               
  cpus_req                       int(10) unsigned                                                                                                                                   
  derived_ec                     int(10) unsigned                                                                                                                                   
  derived_es                     text                                                                                                                                               
  env_hash_inx                   bigint(20) unsigned                                                                                                                                
  exit_code                      int(10) unsigned                                                                                                                                   
  extra                          text                                                                                                                                               
  flags                          int(10) unsigned                                                                                                                                   
  failed_node                    tinytext                                                                                                                                           
  job_name                       tinytext                                                                                                                                           
  id_assoc                       int(10) unsigned                                                                                                                                   
  id_array_job                   int(10) unsigned                                                                                                                                   
  id_array_task                  int(10) unsigned                                                                                                                                   
  id_block                       tinytext                                                                                                                                           
  id_job                         int(10) unsigned                                                                                                                                   
  id_qos                         int(10) unsigned                                                                                                                                   
  id_resv                        int(10) unsigned                                                                                                                                   
  id_wckey                       int(10) unsigned                                                                                                                                   
  id_user                        int(10) unsigned                                                                                                                                   
  id_group                       int(10) unsigned                                                                                                                                   
  het_job_id                     int(10) unsigned                                                                                                                                   
  het_job_offset                 int(10) unsigned                                                                                                                                   
  kill_requid                    int(10) unsigned                                                                                                                                   
  state_reason_prev              int(10) unsigned                                                                                                                                   
  licenses                       text                                                                                                                                               
  mcs_label                      tinytext                                                                                                                                           
  mem_req                        bigint(20) unsigned                                                                                                                                
  nodelist                       text                                                                                                                                               
  nodes_alloc                    int(10) unsigned                                                                                                                                   
  node_inx                       text                                                                                                                                               
  partition                      tinytext                                                                                                                                           
  priority                       int(10) unsigned                                                                                                                                   
  qos_req                        text                                                                                                                                               
  restart_cnt                    smallint(5) unsigned                                                                                                                               
  resv_req                       text                                                                                                                                               
  script_hash_inx                bigint(20) unsigned                                                                                                                                
  state                          int(10) unsigned                                                                                                                                   
  timelimit                      int(10) unsigned                                                                                                                                   
  time_submit                    bigint(20) unsigned                                                                                                                                
  time_eligible                  bigint(20) unsigned                                                                                                                                
  time_start                     bigint(20) unsigned                                                                                                                                
  time_end                       bigint(20) unsigned                                                                                                                                
  time_suspended                 bigint(20) unsigned                                                                                                                                
  gres_used                      text                                                                                                                                               
  wckey                          tinytext                                                                                                                                           
  work_dir                       text                                                                                                                                               
  segment_size                   smallint(5) unsigned                                                                                                                               
  std_err                        text                                                                                                                                               
  std_in                         text                                                                                                                                               
  std_out                        text                                                                                                                                               
  submit_line                    longtext                                                                                                                                           
  system_comment                 text                                                                                                                                               
  tres_alloc                     text                                                                                                                                               
  tres_req                       text                                                                                                                                               
                                                                                                                                                                                    
  === create_last_ran_table ===                                                                                                                                                     
  hourly_rollup                  bigint(20) unsigned                                                                                                                                
  daily_rollup                   bigint(20) unsigned                                                                                                                                
  monthly_rollup                 bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_qos_usage_day_table ===                                                                                                                                                
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_qos_usage_hour_table ===                                                                                                                                               
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_qos_usage_month_table ===                                                                                                                                              
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_resv_table ===                                                                                                                                                         
  id_resv                        int(10) unsigned                                                                                                                                   
  deleted                        tinyint(4)                                                                                                                                         
  assoclist                      text                                                                                                                                               
  flags                          bigint(20) unsigned                                                                                                                                
  nodelist                       text                                                                                                                                               
  node_inx                       text                                                                                                                                               
  resv_name                      text                                                                                                                                               
  time_start                     bigint(20) unsigned                                                                                                                                
  time_end                       bigint(20) unsigned                                                                                                                                
  time_force                     bigint(20) unsigned                                                                                                                                
  tres                           text                                                                                                                                               
  unused_wall                    double unsigned                                                                                                                                    
  comment                        text                                                                                                                                               
                                                                                                                                                                                    
  === create_step_table ===                                                                                                                                                         
  job_db_inx                     bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  exit_code                      int(11)                                                                                                                                            
  id_step                        int(11)                                                                                                                                            
  step_het_comp                  int(10) unsigned                                                                                                                                   
  kill_requid                    int(10) unsigned                                                                                                                                   
  nodelist                       text                                                                                                                                               
  nodes_alloc                    int(10) unsigned                                                                                                                                   
  node_inx                       text                                                                                                                                               
  state                          smallint(5) unsigned                                                                                                                               
  step_name                      text                                                                                                                                               
  task_cnt                       int(10) unsigned                                                                                                                                   
  task_dist                      int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  time_end                       bigint(20) unsigned                                                                                                                                
  time_suspended                 bigint(20) unsigned                                                                                                                                
  timelimit                      int(10) unsigned                                                                                                                                   
  user_sec                       bigint(20) unsigned                                                                                                                                
  user_usec                      int(10) unsigned                                                                                                                                   
  sys_sec                        bigint(20) unsigned                                                                                                                                
  sys_usec                       int(10) unsigned                                                                                                                                   
  act_cpufreq                    double unsigned                                                                                                                                    
  consumed_energy                bigint(20) unsigned                                                                                                                                
  container                      text                                                                                                                                               
  req_cpufreq_min                int(10) unsigned                                                                                                                                   
  req_cpufreq                    int(10) unsigned                                                                                                                                   
  req_cpufreq_gov                int(10) unsigned                                                                                                                                   
  cwd                            text                                                                                                                                               
  std_err                        text                                                                                                                                               
  std_in                         text                                                                                                                                               
  std_out                        text                                                                                                                                               
  submit_line                    longtext                                                                                                                                           
  tres_alloc                     text                                                                                                                                               
  tres_usage_in_ave              text                                                                                                                                               
  tres_usage_in_max              text                                                                                                                                               
  tres_usage_in_max_taskid       text                                                                                                                                               
  tres_usage_in_max_nodeid       text                                                                                                                                               
  tres_usage_in_min              text                                                                                                                                               
  tres_usage_in_min_taskid       text                                                                                                                                               
  tres_usage_in_min_nodeid       text                                                                                                                                               
  tres_usage_in_tot              text                                                                                                                                               
  tres_usage_out_ave             text                                                                                                                                               
  tres_usage_out_max             text                                                                                                                                               
  tres_usage_out_max_taskid      text                                                                                                                                               
  tres_usage_out_max_nodeid      text                                                                                                                                               
  tres_usage_out_min             text                                                                                                                                               
  tres_usage_out_min_taskid      text                                                                                                                                               
  tres_usage_out_min_nodeid      text                                                                                                                                               
  tres_usage_out_tot             text                                                                                                                                               
                                                                                                                                                                                    
  === create_suspend_table ===                                                                                                                                                      
  deleted                        tinyint(4)                                                                                                                                         
  job_db_inx                     bigint(20) unsigned                                                                                                                                
  id_assoc                       int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  time_end                       bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_usage_day_table ===                                                                                                                                                    
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  count                          bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
  down_secs                      bigint(20) unsigned                                                                                                                                
  pdown_secs                     bigint(20) unsigned                                                                                                                                
  idle_secs                      bigint(20) unsigned                                                                                                                                
  plan_secs                      bigint(20) unsigned                                                                                                                                
  over_secs                      bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_usage_hour_table ===                                                                                                                                                   
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  count                          bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
  down_secs                      bigint(20) unsigned                                                                                                                                
  pdown_secs                     bigint(20) unsigned                                                                                                                                
  idle_secs                      bigint(20) unsigned                                                                                                                                
  plan_secs                      bigint(20) unsigned                                                                                                                                
  over_secs                      bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_usage_month_table ===                                                                                                                                                  
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  count                          bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
  down_secs                      bigint(20) unsigned                                                                                                                                
  pdown_secs                     bigint(20) unsigned                                                                                                                                
  idle_secs                      bigint(20) unsigned                                                                                                                                
  plan_secs                      bigint(20) unsigned                                                                                                                                
  over_secs                      bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_wckey_table ===                                                                                                                                                        
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  is_def                         tinyint(4)                                                                                                                                         
  id_wckey                       int(10) unsigned                                                                                                                                   
  wckey_name                     tinytext                                                                                                                                           
  user                           tinytext                                                                                                                                           
                                                                                                                                                                                    
  === create_wckey_usage_day_table ===                                                                                                                                              
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_wckey_usage_hour_table ===                                                                                                                                             
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === create_wckey_usage_month_table ===                                                                                                                                            
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(10) unsigned                                                                                                                                   
  id_alt                         int(10) unsigned                                                                                                                                   
  id_tres                        int(11)                                                                                                                                            
  time_start                     bigint(20) unsigned                                                                                                                                
  alloc_secs                     bigint(20) unsigned                                                                                                                                
                                                                                                                                                                                    
  === federation_table ===                                                                                                                                                          
  creation_time                  int(10) unsigned                                                                                                                                   
  mod_time                       int(10) unsigned                                                                                                                                   
  deleted                        tinyint(4)                                                                                                                                         
  name                           tinytext                                                                                                                                           
  flags                          int(10) unsigned                                                                                                                                   
                                                                                                                                                                                    
  === qos_table ===                                                                                                                                                                 
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(11)                                                                                                                                            
  name                           tinytext                                                                                                                                           
  description                    text                                                                                                                                               
  flags                          int(10) unsigned                                                                                                                                   
  grace_time                     int(10) unsigned                                                                                                                                   
  max_jobs_pa                    int(11)                                                                                                                                            
  max_jobs_per_user              int(11)                                                                                                                                            
  max_jobs_accrue_pa             int(11)                                                                                                                                            
  max_jobs_accrue_pu             int(11)                                                                                                                                            
  min_prio_thresh                int(11)                                                                                                                                            
  max_submit_jobs_pa             int(11)                                                                                                                                            
  max_submit_jobs_per_user       int(11)                                                                                                                                            
  max_tres_pa                    text                                                                                                                                               
  max_tres_pj                    text                                                                                                                                               
  max_tres_pn                    text                                                                                                                                               
  max_tres_pu                    text                                                                                                                                               
  max_tres_mins_pj               text                                                                                                                                               
  max_tres_run_mins_pa           text                                                                                                                                               
  max_tres_run_mins_pu           text                                                                                                                                               
  min_tres_pj                    text                                                                                                                                               
  max_wall_duration_per_job      int(11)                                                                                                                                            
  grp_jobs                       int(11)                                                                                                                                            
  grp_jobs_accrue                int(11)                                                                                                                                            
  grp_submit_jobs                int(11)                                                                                                                                            
  grp_tres                       text                                                                                                                                               
  grp_tres_mins                  text                                                                                                                                               
  grp_tres_run_mins              text                                                                                                                                               
  grp_wall                       int(11)                                                                                                                                            
  preempt                        text                                                                                                                                               
  preempt_mode                   int(11)                                                                                                                                            
  preempt_exempt_time            int(10) unsigned                                                                                                                                   
  priority                       int(10) unsigned                                                                                                                                   
  usage_factor                   double                                                                                                                                             
  usage_thres                    double                                                                                                                                             
  limit_factor                   double                                                                                                                                             
                                                                                                                                                                                    
  === res_table ===                                                                                                                                                                 
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(11)                                                                                                                                            
  name                           tinytext                                                                                                                                           
  description                    text                                                                                                                                               
  manager                        tinytext                                                                                                                                           
  server                         tinytext                                                                                                                                           
  count                          int(10) unsigned                                                                                                                                   
  type                           int(10) unsigned                                                                                                                                   
  flags                          int(10) unsigned                                                                                                                                   
  last_consumed                  int(10) unsigned                                                                                                                                   
                                                                                                                                                                                    
  === table_defs_table ===                                                                                                                                                          
  creation_time                  int(10) unsigned                                                                                                                                   
  mod_time                       int(10) unsigned                                                                                                                                   
  table_name                     text                                                                                                                                               
  definition                     text                                                                                                                                               
                                                                                                                                                                                    
  === tres_table ===                                                                                                                                                                
  creation_time                  bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(11)                                                                                                                                            
  type                           tinytext                                                                                                                                           
  name                           tinytext                                                                                                                                           
                                                                                                                                                                                    
  === txn_table ===                                                                                                                                                                 
  deleted                        tinyint(4)                                                                                                                                         
  id                             int(11)                                                                                                                                            
  timestamp                      bigint(20) unsigned                                                                                                                                
  action                         smallint(6)                                                                                                                                        
  name                           text                                                                                                                                               
  actor                          tinytext                                                                                                                                           
  cluster                        tinytext                                                                                                                                           
  info                           blob                                                                                                                                               
                                                                                                                                                                                    
  === user_table ===                                                                                                                                                                
  creation_time                  bigint(20) unsigned                                                                                                                                
  mod_time                       bigint(20) unsigned                                                                                                                                
  deleted                        tinyint(4)                                                                                                                                         
  name                           tinytext                                                                                                                                           
  admin_level                    smallint(6)                                                                                                                                        
  Yes, let's filter only for completed jobs for job efficiency. And let's do both: include FAILED/TIMEOOUT jobs, and have a separate stat without the failed/timed out jobs.        

● This is extremely helpful. Now I can see exactly what's available.

  Key findings from the schema

  In create_job_table:
  ┌─────────────┬───────────┬───────────────────────────────────┐
  │    Field    │ Available │               Notes               │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ exit_code   │ ✓         │ Direct column                     │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ timelimit   │ ✓         │ Direct column (likely in minutes) │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ time_submit │ ✓         │ Unix timestamp                    │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ time_start  │ ✓         │ Unix timestamp                    │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ time_end    │ ✓         │ Unix timestamp                    │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ cpus_req    │ ✓         │ Direct column                     │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ mem_req     │ ✓         │ Direct column (bytes)             │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ state       │ ✓         │ Numeric state code                │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ TotalCPU    │ ✗         │ Not here - in step table          │
  ├─────────────┼───────────┼───────────────────────────────────┤
  │ MaxRSS      │ ✗         │ Not here - in step table          │
  └─────────────┴───────────┴───────────────────────────────────┘
  In create_step_table:
  ┌──────────┬────────────────────┬─────────────────────────────────┐
  │  Field   │       Column       │              Notes              │
  ├──────────┼────────────────────┼─────────────────────────────────┤
  │ TotalCPU │ user_sec + sys_sec │ Plus microseconds for precision │
  ├──────────┼────────────────────┼─────────────────────────────────┤
  │ MaxRSS   │ tres_usage_in_max  │ Text field, needs parsing       │
  └──────────┴────────────────────┴─────────────────────────────────┘
  The complication: TRES format

  tres_usage_in_max is a text field containing something like "1=12345,2=67890" where the numbers map to resource IDs in tres_table. We'd need to:
  1. Query tres_table to find which ID = memory
  2. Parse the string to extract that value

  Could you run this query to see what's in tres_table?
  SELECT * FROM tres_table;

  And maybe a sample of tres_usage_in_max from create_step_table to confirm the format?

  Revised understanding of the output

  Based on our discussion, here's what we'll output per group (faculty or global):

  Counts:
  - Job count (all completed)
  - Job count (successful only, exit_code=0)
  - Job count (failed/timeout)
  - Exit code breakdown (count per distinct exit code)

  Resource totals:
  - Total elapsed seconds
  - Total CPU seconds (actual usage)
  - Total MaxRSS bytes (actual memory)
  - Total requested memory bytes
  - Total allocated CPUs

  Efficiency metrics:
  - Weighted CPU efficiency: Sum(TotalCPU) / Sum(Elapsed × AllocCPUs)
  - Average CPU efficiency: Mean(per-job efficiency)
  - Weighted memory efficiency: Sum(MaxRSS) / Sum(ReqMem)
  - Average memory efficiency: Mean(per-job efficiency)
  - (All four above, both including and excluding failed jobs)

  Wait time:
  - Total wait time (sum of time_start - time_submit)
  - Average wait time

  Time efficiency (new):
  - Weighted: Sum(Elapsed) / Sum(Timelimit)
  - Average: Mean(per-job time efficiency)

  Questions before coding

  1. The state column is numeric. Do you know the mapping? (Typically: 3=COMPLETED, 4=CANCELLED, 5=FAILED, 6=TIMEOUT, etc.) Or should we filter by time_end > 0 instead?
  2. For the step table join - a job can have multiple steps. Should we:
    - Sum user_sec + sys_sec across all steps for TotalCPU?
    - Take MAX of MaxRSS across steps?
  3. Confirm the output format: CSV to stdout (like current scripts), or something else?

✻ Cogitated for 32s

❯ Re tres format: can you exactly explain the problem? I don't understand. What is tres_usage_in_max? Do I just paste "SELECT * FROM tres_table;" into the terminal? "And maybe a   
  sample of tres_usage_in_max from create_step_table to confirm the format?" --> How do I do that?                                                                                  

● Let me explain more clearly.

  What is TRES?

  TRES = Trackable RESources. It's Slurm's generic way of tracking different resource types (CPU, memory, GPU, nodes, etc.) using IDs instead of separate columns.

  The problem

  Instead of having a column like max_memory_bytes = 12345678, Slurm stores it in a text field like:

  tres_usage_in_max = "1=500,2=12345678,4=1"

  Where:
  - 1 might mean "CPU"
  - 2 might mean "Memory"
  - 4 might mean "Node"

  We don't know which number means what without checking the tres_table, which holds the mapping.

  How to query the database

  You'd need to connect to MySQL and run the query. Here's a small Python script you could run:

  import mysql.connector

  conn = mysql.connector.connect(
      host="ermysqlr2.er.kcl.ac.uk",
      user="slurm_create_ro",
      password="qu4c46wQookqTWdq",
      database="slurm_create"
  )
  cursor = conn.cursor()

  # Query 1: See what resource types exist
  print("=== TRES TABLE ===")
  cursor.execute("SELECT * FROM tres_table")
  for row in cursor:
      print(row)

  # Query 2: See a sample of tres_usage_in_max format
  print("\n=== SAMPLE tres_usage_in_max ===")
  cursor.execute("SELECT tres_usage_in_max FROM create_step_table WHERE tres_usage_in_max IS NOT NULL AND tres_usage_in_max != '' LIMIT 5")
  for row in cursor:
      print(row)

  cursor.close()
  conn.close()

  Or from the command line if you have the mysql client:

  mysql -h ermysqlr2.er.kcl.ac.uk -u slurm_create_ro -p'qu4c46wQookqTWdq' slurm_create -e "SELECT * FROM tres_table;"

  What I expect we'll find

  Something like:
  ┌─────┬────────┬──────┐
  │ id  │  type  │ name │
  ├─────┼────────┼──────┤
  │ 1   │ cpu    │      │
  ├─────┼────────┼──────┤
  │ 2   │ mem    │      │
  ├─────┼────────┼──────┤
  │ 3   │ energy │      │
  ├─────┼────────┼──────┤
  │ 4   │ node   │      │
  ├─────┼────────┼──────┤
  │ 5   │ gres   │ gpu  │
  └─────┴────────┴──────┘
  Then when we see tres_usage_in_max = "1=500,2=12345678", we'd know:
  - 1=500 → 500 CPU-seconds
  - 2=12345678 → 12345678 bytes of memory (MaxRSS)

  Alternative approach

  If this TRES parsing turns out to be too messy, we could potentially use user_sec + sys_sec for CPU time directly (those are plain numeric columns in create_step_table), and see if there's another way to get memory usage.

  Want me to write that query script as a file you can run?

❯ I have this output (on King's HPC CREATE): k2472719@erc-hpc-login1:~$ mysql -h ermysqlr2.er.kcl.ac.uk -u slurm_create_ro -p'qu4c46wQookqTWdq' slurm_create -e "SELECT * FROM      
  tres_table;"                                                                                                                                                                      
  Command 'mysql' not found, but can be installed with:                                                                                                                             
  apt install mysql-client-core-8.0     # version 8.0.35-0ubuntu0.22.04.1, or                                                                                                       
  apt install mariadb-client-core-10.6  # version 1:10.6.12-0ubuntu0.22.04.1 (You will have to enable component called 'universe')                                                  
  Ask your administrator to install one of them.                                                                                                                                    

● No problem - let's use Python instead since you already have the mysql connector library (faculty_stats.py uses it). Let me write a quick query script.

● Write(query_tres.py)
  ⎿  Wrote 44 lines to query_tres.py                                               
      1 #!/usr/bin/env python3
      2 """Quick script to check TRES table and sample tres_usage_in_max format."""
      3 import mysql.connector
      4 conn = mysql.connector.connect(
      5     host="ermysqlr2.er.kcl.ac.uk",
      6     user="slurm_create_ro",
      7     password="qu4c46wQookqTWdq",
      8     database="slurm_create"
     … +34 lines (ctrl+o to expand)

● I've created query_tres.py in your repo. You can run it on the HPC with:

  python3 query_tres.py

  This will show us:
  1. The TRES table (mapping of IDs to resource types)
  2. Sample tres_usage_in_max values (so we can see the format)
  3. Sample user_sec/sys_sec values (to confirm CPU time data exists)

  Once you share the output, I'll know exactly how to parse the data for MaxRSS and TotalCPU.

❯ This is the output: 

● I see you started to share the output but it got cut off. Could you paste the full output from running the script?

❯ k2472719@erc-hpc-login1:~$ python3 query_tres.py                                                                                                                                  
  === TRES TABLE ===                                                                                                                                                                
  (1643819465, 0, 1, 'cpu', '')                                                                                                                                                     
  (1643819465, 0, 2, 'mem', '')                                                                                                                                                     
  (1643819465, 0, 3, 'energy', '')                                                                                                                                                  
  (1643819465, 0, 4, 'node', '')                                                                                                                                                    
  (1643819465, 0, 5, 'billing', '')                                                                                                                                                 
  (1643819465, 0, 6, 'fs', 'disk')                                                                                                                                                  
  (1643819465, 0, 7, 'vmem', '')                                                                                                                                                    
  (1643819465, 0, 8, 'pages', '')                                                                                                                                                   
  (1643819465, 1, 1000, 'dynamic_offset', '')                                                                                                                                       
  (1643975316, 0, 1001, 'gres', 'gpu')                                                                                                                                              
  (1683057975, 0, 1004, 'gres', 'gpuutil')                                                                                                                                          
  (1683057975, 0, 1007, 'gres', 'gpumem')                                                                                                                                           
                                                                                                                                                                                    
  === SAMPLE tres_usage_in_max ===                                                                                                                                                  
  ('1=40,2=0,3=0,6=0,7=219369472,8=0',)                                                                                                                                             
  ('1=30,2=1757184,3=0,6=394022,7=219369472,8=0',)                                                                                                                                  
  ('1=200,2=1892352,3=0,6=1744161,7=219369472,8=0',)                                                                                                                                
  ('1=3727150,2=3784704,3=0,6=5209345,7=219369472,8=0',)                                                                                                                            
  ('1=4720540,2=2703360,3=0,6=404308,7=219369472,8=0',)                                                                                                                             
                                                                                                                                                                                    
  === SAMPLE CPU TIME (user_sec, sys_sec) ===                                                                                                                                       
  (3726, 0, 92106, 544485)                                                                                                                                                          
  (4720, 0, 32608, 19577)                                                                                                                                                           
  (1, 60, 152704, 757055)                                                                                                                                                           
  (17744, 8984, 948345, 212150)                                                                                                                                                     
  (17940, 9135, 985855, 570613)                                                                                                                                                     

● Excellent! Now I understand the format. Here's what we learned:

  TRES ID Mapping
  ┌──────┬──────────┬─────────────────┐
  │  ID  │   Type   │   What it is    │
  ├──────┼──────────┼─────────────────┤
  │ 1    │ cpu      │ CPU usage       │
  ├──────┼──────────┼─────────────────┤
  │ 2    │ mem      │ Memory (MaxRSS) │
  ├──────┼──────────┼─────────────────┤
  │ 7    │ vmem     │ Virtual memory  │
  ├──────┼──────────┼─────────────────┤
  │ 1001 │ gres:gpu │ GPU             │
  └──────┴──────────┴─────────────────┘
  tres_usage_in_max Format

  It's a comma-separated string of ID=value pairs:
  "1=3727150,2=3784704,3=0,6=5209345,7=219369472,8=0"

  So to get MaxRSS, we parse out the value after 2=.

  CPU Time

  The user_sec and sys_sec columns are straightforward:
  TotalCPU = user_sec + sys_sec + (user_usec + sys_usec) / 1_000_000

  From the sample: user_sec=3726, sys_sec=0 → ~3726 seconds of CPU time.

  One question: Memory units

  The 2= values in tres_usage_in_max are small numbers like 3784704. This could be:
  - Bytes: 3784704 bytes = ~3.6 MB (seems low for HPC jobs)
  - KB: 3784704 KB = ~3.6 GB (more typical)

  Do you happen to know from experience what typical memory usage looks like? Or we could cross-check by running a known job through both sacct and this query to compare values.

  Summary: We have what we need
  ┌───────────┬───────────────────┬──────────────────────────────────┐
  │  Metric   │      Source       │              Method              │
  ├───────────┼───────────────────┼──────────────────────────────────┤
  │ TotalCPU  │ create_step_table │ user_sec + sys_sec               │
  ├───────────┼───────────────────┼──────────────────────────────────┤
  │ MaxRSS    │ create_step_table │ Parse 2=X from tres_usage_in_max │
  ├───────────┼───────────────────┼──────────────────────────────────┤
  │ Timelimit │ create_job_table  │ timelimit column                 │
  ├───────────┼───────────────────┼──────────────────────────────────┤
  │ Wait time │ create_job_table  │ time_start - time_submit         │
  ├───────────┼───────────────────┼──────────────────────────────────┤
  │ Exit code │ create_job_table  │ exit_code column                 │
  └───────────┴───────────────────┴──────────────────────────────────┘
  The step table links to job table via job_db_inx. For jobs with multiple steps, we'd sum CPU time and take max of MaxRSS.

  Ready to start writing the combined script, or do you want to verify the memory units first?

✻ Sautéed for 36s

❯ Mmh what would be a "known" job that I could run? For now, we can assume GB, as this makes more sense, as you say. 

● Good point - verifying would require running a job, waiting for it to complete, then comparing sacct output with the database. Let's just proceed with the assumption that the memory values are in KB (making ~3.6 GB typical, which is reasonable).

  We can always adjust the unit multiplier later if the numbers look off.

  Let me outline the plan for the new script and then start writing it.

● Write(hpc_stats.py)
  ⎿  Wrote 537 lines to hpc_stats.py                                                          
      1 #!/usr/bin/env python3
      2 """
      3 HPC Statistics Export Tool
      4 Combines job data from Slurm MySQL database with LDAP user attributes
      5 to produce aggregated statistics by faculty (or other LDAP attributes),
      6 including resource efficiency metrics.
      7 Usage:
      8     python3 hpc_stats.py --collate_by st=faculty --since 2025-01-01 --until 2025-02-01
     … +527 lines (ctrl+o to expand)

● I've created hpc_stats.py. Here's what it does:

  Usage

  # By faculty
  python3 hpc_stats.py --collate_by st=faculty --since 2025-01-01 --until 2025-02-01

  # Global stats (no grouping)
  python3 hpc_stats.py --collate_by none --since 2025-01-01 --until 2025-02-01

  # Both at once
  python3 hpc_stats.py --collate_by st=faculty --collate_by none --since 2025-01-01 --until 2025-02-01

  Output Columns
  ┌───────────────────────┬───────────────────────────────────────────┐
  │        Column         │                Description                │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ job_count             │ Total completed jobs                      │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ job_count_success     │ Jobs with exit_code=0                     │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ job_count_failed      │ Failed/timeout jobs                       │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_elapsed_sec     │ Sum of wall-clock time                    │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_cpu_sec         │ Sum of actual CPU usage                   │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_maxrss_bytes    │ Sum of actual memory used                 │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_reqmem_bytes    │ Sum of requested memory                   │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_alloccpus       │ Sum of allocated CPUs                     │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ total_wait_sec        │ Sum of queue wait time                    │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ avg_wait_sec          │ Average queue wait time                   │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ weighted_cpu_eff_pct  │ Sum(TotalCPU) / Sum(Elapsed×CPUs)         │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ avg_cpu_eff_pct       │ Mean of per-job CPU efficiency            │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ weighted_mem_eff_pct  │ Sum(MaxRSS) / Sum(ReqMem)                 │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ avg_mem_eff_pct       │ Mean of per-job memory efficiency         │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ weighted_time_eff_pct │ Sum(Elapsed) / Sum(Timelimit)             │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ avg_time_eff_pct      │ Mean of per-job time efficiency           │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ success_*             │ Same metrics but only for successful jobs │
  ├───────────────────────┼───────────────────────────────────────────┤
  │ exit_codes            │ Breakdown like "0:150;1:20;9:3"           │
  └───────────────────────┴───────────────────────────────────────────┘
  Key Design Decisions

  1. MySQL + Step table join: Gets TotalCPU from user_sec + sys_sec, MaxRSS from parsing tres_usage_in_max
  2. Memory units: Assumes TRES memory values are in KB, converts to bytes
  3. Finished jobs only: Filters for states 3,4,5,6,7 (completed, cancelled, failed, timeout, node_fail)
  4. Dual efficiency stats: Both "all jobs" and "successful only" versions

  Things to verify

  1. Job state codes: I used typical Slurm values (3=COMPLETED, 5=FAILED, etc.). These might differ on your cluster.
  2. Memory units: If values look ~1000x off, adjust the * 1024 multiplier in parse_tres_value
  3. Timelimit units: I assumed it's stored in minutes (converted to seconds)

  Want to test it with a small date range first?

✻ Baked for 2m 9s

❯ What would the output look like if we used faculty and global stats? And does it work, if we have sf=faculty in one case, and none (rather than sf=none) in the other? And I      
  wonder how to treat completed vs. running jobs - does it make sense to count in everything for all variables except the efficiency stats, or should we separate all stats (except 
  for efficiency) into running and completed? How can I find out about job state codes? And yes, time limit is in minutes.                                                          

● Good questions. Let me address each:

  1. Output example with both faculty and global

  Statistics collated by faculty:
  faculty,job_count,job_count_success,job_count_failed,...
  "Faculty of Life Sciences & Medicine",9555,9200,355,...
  "IoPPN",102198,98000,4198,...
  "unknown",3020,2800,220,...

  Global statistics:
  global,job_count,job_count_success,job_count_failed,...
  "all",138000,132000,6000,...

  You'd get two separate CSV outputs - one grouped by faculty, one with a single "all" row.

  2. Does --collate_by st=faculty --collate_by none work?

  Yes, that's the intended syntax. The code checks if the value is literally "none" (case-insensitive) and treats it specially. So:

  python3 hpc_stats.py --collate_by st=faculty --collate_by none --since 2025-01-01 --until 2025-02-01

  This would output both faculty-grouped stats and global stats.

  3. Running vs completed jobs

  Currently, I filter out running jobs entirely. You raise a good point - there are two approaches:

  Option A: Current approach (completed only)
  - Simpler, all stats are comparable
  - Running jobs have no final data anyway

  Option B: Separate running/completed counts
  - Add columns like job_count_running, job_count_pending
  - Only calculate efficiency for completed jobs
  - Useful for seeing "how many jobs are currently active per faculty"

  The question is: is a snapshot of currently-running jobs useful in a report that queries a date range? Running jobs would only appear if they were submitted in that range but haven't finished yet.

  My suggestion: stick with completed-only for this tool, since efficiency metrics require completed jobs anyway. If you want a "current state" report (what's running now), that's a different query.

  What do you think?

  4. Finding job state codes

  Let me write a quick query to see what states actually exist in your data:

● Write(query_job_states.py)
  ⎿  Wrote 42 lines to query_job_states.py                       
      1 #!/usr/bin/env python3
      2 """Query to see what job states exist in the database."""
      3 import mysql.connector
      4 conn = mysql.connector.connect(
      5     host="ermysqlr2.er.kcl.ac.uk",
      6     user="slurm_create_ro",
      7     password="qu4c46wQookqTWdq",
      8     database="slurm_create"
     … +32 lines (ctrl+o to expand)

● Run this to see what states exist in your database:

  python3 query_job_states.py

  This will show you:
  1. What state codes are actually present and how many jobs have each state
  2. The typical Slurm state code mapping (for reference)

  Once you see the output, we can verify the codes match what I used in hpc_stats.py and adjust if needed.

❯ Will this script run for long? It's currently running. I see stuff like "print("0  = PENDING")" in the code, that doesn't make sense, does it? You don't know the code meanings.  
  And isn't there a different way to find out about job state codes? There must be a matching somewhere in the database, no?                                                        

● You're right on both counts:

  1. The hardcoded print statements - That was sloppy of me. I don't actually know what codes your cluster uses. I should have just shown the query results without guessing.
  2. The query might be slow - It's scanning the entire create_job_table without a date filter. If there are millions of jobs, it could take a while.
  3. Mapping in the database - Looking back at the schema you shared, I don't see an obvious state mapping table. The states are typically defined in Slurm's source code, not stored in the database.

  To find the actual mapping, you could:

  1. Check Slurm documentation for your Slurm version:
  scontrol show config | grep -i version
  1. Then look up the state codes for that version.
  2. Use sacct to cross-reference - pick a job ID, check its state in sacct (which shows the text), then look up the numeric code in the database:
  sacct -j <some_job_id> -o JobID,State
  2. Then query that job in MySQL to see its numeric state.

  If the query is still running, you can cancel it (Ctrl+C) and I'll write a faster version with a date filter:

  # Add WHERE clause to limit the scan
  cursor.execute("""
      SELECT state, COUNT(*) as cnt
      FROM create_job_table
      WHERE time_submit >= UNIX_TIMESTAMP('2025-01-01')
      GROUP BY state
      ORDER BY cnt DESC
  """)

  Want me to update the script with a date-limited version?

❯ How do I exit the program? Ctrl+X doesn't help. And yes, write a script that is faster (and doesn't assume code meanings in the first place). 

● To exit: press Ctrl+C (not Ctrl+X). That sends an interrupt signal to stop the program.

● Update(query_job_states.py)
  ⎿  Added 9 lines, removed 18 lines                                                                                                                                             
      1  #!/usr/bin/env python3
      2 -"""Query to see what job states exist in the database."""                                                                                                               
      2 +"""Query to see what job states exist in the database (recent jobs only for speed)."""                                                                                  
      3  
      4  import mysql.connector
      5  
     ...
      11  )
      12  cursor = conn.cursor()
      13  
      14 -print("=== JOB STATES IN DATABASE ===")                                                                                                                                
      15 -print("(state code, count)")                                                                                                                                           
      14 +print("=== JOB STATES IN DATABASE (Jan 2025) ===")                                                                                                                     
      15 +print("state_code, count")                                                                                                                                             
      16  cursor.execute("""
      17      SELECT state, COUNT(*) as cnt
      18      FROM create_job_table
      19 +    WHERE time_submit >= UNIX_TIMESTAMP('2025-01-01')                                                                                                                  
      20 +      AND time_submit < UNIX_TIMESTAMP('2025-02-01')                                                                                                                   
      21      GROUP BY state
      22      ORDER BY cnt DESC
      23  """)
      24  for row in cursor:
      23 -    print(row)                                                                                                                                                         
      25 +    print(f"{row[0]}, {row[1]}")                                                                                                                                       
      26  
      25 -print("\n=== SLURM STATE CODE REFERENCE ===")                                                                                                                          
      26 -print("0  = PENDING")                                                                                                                                                  
      27 -print("1  = RUNNING")                                                                                                                                                  
      28 -print("2  = SUSPENDED")                                                                                                                                                
      29 -print("3  = COMPLETED")                                                                                                                                                
      30 -print("4  = CANCELLED")                                                                                                                                                
      31 -print("5  = FAILED")                                                                                                                                                   
      32 -print("6  = TIMEOUT")                                                                                                                                                  
      33 -print("7  = NODE_FAIL")                                                                                                                                                
      34 -print("8  = PREEMPTED")                                                                                                                                                
      35 -print("9  = BOOT_FAIL")                                                                                                                                                
      36 -print("10 = DEADLINE")                                                                                                                                                 
      37 -print("11 = OUT_OF_MEMORY")                                                                                                                                            
      38 -print("(These are typical Slurm values - your cluster may differ)")                                                                                                    
      27 +print("\nTo find what each code means, run:")                                                                                                                          
      28 +print("  sacct -j <job_id> -o JobID,State")                                                                                                                            
      29 +print("for a job with that state, then compare with the code above.")                                                                                                  
      30  
      31  cursor.close()
      32  conn.close()

● Updated. The new version:
  - Only queries January 2025 (much faster)
  - Doesn't assume what the codes mean
  - Suggests how to cross-reference with sacct

  After you Ctrl+C out of the stuck script, run:

  python3 query_job_states.py

  This should complete in seconds.

❯ I just found: "The King's HPC CREATE cluster uses the                                                                                                                             
  Slurm Workload Manager, so its job state codes are the standard Slurm codes." Ctrl+C doesn't do anything.                                                                         

● Good to know about the standard Slurm codes - so my original reference was likely correct after all.

  For the stuck program, try these alternatives:

  1. Ctrl+ (backslash) - sends a stronger SIGQUIT signal
  2. Ctrl+Z to suspend it, then kill it:
  kill %1
  3. If those don't work, open another terminal and:
  ps aux | grep query_job
  kill <pid>
  4. Or just close the terminal window and open a new one

  Once you're out, the updated script should run quickly with the date filter.

❯ I found these two websites: https://slurm.schedmd.com/job_state_codes.html, https://docs.er.kcl.ac.uk/CREATE/running_jobs/. Can you scan those to check for state codes? 

● Fetch(https://slurm.schedmd.com/job_state_codes.html)
  ⎿  Received 9.1KB (200 OK)

● Fetch(https://docs.er.kcl.ac.uk/CREATE/running_jobs/)
  ⎿  Received 108KB (200 OK)

● The official Slurm page lists state names but not the numeric codes. The King's docs only mention a few states (R, PD, CG).

  However, since King's uses standard Slurm, the numeric codes are defined in Slurm's source code (slurm.h). Here are the standard mappings:
  ┌──────┬───────────────┬─────────────────────────────────────┐
  │ Code │     State     │               Meaning               │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 0    │ PENDING       │ Waiting in queue                    │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 1    │ RUNNING       │ Currently executing                 │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 2    │ SUSPENDED     │ Execution suspended                 │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 3    │ COMPLETED     │ Finished successfully (exit code 0) │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 4    │ CANCELLED     │ Cancelled by user/admin             │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 5    │ FAILED        │ Finished with non-zero exit code    │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 6    │ TIMEOUT       │ Hit time limit                      │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 7    │ NODE_FAIL     │ Node failed                         │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 8    │ PREEMPTED     │ Preempted by higher priority job    │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 9    │ BOOT_FAIL     │ Node boot failure                   │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 10   │ DEADLINE      │ Missed deadline                     │
  ├──────┼───────────────┼─────────────────────────────────────┤
  │ 11   │ OUT_OF_MEMORY │ OOM killed                          │
  └──────┴───────────────┴─────────────────────────────────────┘
  So my original values in hpc_stats.py were correct:

  JOB_STATE_COMPLETED = 3
  JOB_STATE_FAILED = 5
  JOB_STATE_TIMEOUT = 6
  JOB_STATE_CANCELLED = 4
  JOB_STATE_NODE_FAIL = 7

  Once you escape the stuck script, running the updated query_job_states.py will confirm which of these codes actually appear in your data.

  Did Ctrl+ or Ctrl+Z work to exit?

❯ How can I mark everything in a file and paste new content into it in a terminal on Ubuntu? 

● A few options:

  Option 1: Overwrite with cat (simplest)
  cat > filename.py
  Then paste your content, then press Ctrl+D to save and exit.

  Option 2: Using nano editor
  nano filename.py
  - Ctrl+Shift+6 to start marking
  - Ctrl+6 then Alt+T to select all (or just Ctrl+K repeatedly to delete lines)
  - Paste with Ctrl+Shift+V (or right-click paste)
  - Ctrl+O to save, Ctrl+X to exit

  Option 3: Using vim
  vim filename.py
  - Type ggVG to select all
  - Type d to delete
  - Press i to enter insert mode
  - Paste with Ctrl+Shift+V
  - Press Esc, then type :wq to save and exit

  Option 1 is easiest if you just want to completely replace a file's contents.

❯ Okay, script is running. Let's for now assume the standard exit codes are correct. 

● Good. Let me know what output you get from query_job_states.py - it'll confirm which states are actually present in your January 2025 data.

  Once that's done, we can test the main hpc_stats.py script with a small date range to verify:
  1. The MySQL query works correctly
  2. The LDAP lookups work
  3. The efficiency calculations produce sensible numbers
  4. The memory values are in the right units (KB assumption)

  What output are you seeing?

❯ What would the command look like? 

● For the job states query:
  python3 query_job_states.py

  For testing the main stats script (small date range - just 1 week):
  python3 hpc_stats.py --collate_by st=faculty --since 2025-01-01 --until 2025-01-08

  Or with both faculty and global stats:
  python3 hpc_stats.py --collate_by st=faculty --collate_by none --since 2025-01-01 --until 2025-01-08

  Start with the job states query first to make sure it runs quickly, then try the main script.

❯ I have this output: k2472719@erc-hpc-login2:~$ python3 hpc_stats.py --collate_by st=faculty --collate_by none --since 2025-01-01 --until 2025-01-08                               
  Connecting to LDAP...                                                                                                                                                             
  Connecting to MySQL...                                                                                                                                                            
  Querying jobs...                                                                                                                                                                  
  Traceback (most recent call last):                                                                                                                                                
  File "/cephfs/volumes/hpc_home/k2472719/e8dfa876-ccf0-46d2-94b2-0f78526b0989/hpc_stats.py", line 536, in <module>                                                                 
  main()                                                                                                                                                                            
  File "/cephfs/volumes/hpc_home/k2472719/e8dfa876-ccf0-46d2-94b2-0f78526b0989/hpc_stats.py", line 508, in main                                                                     
  process_job(row, stats_by_attr[attr], value, is_success)                                                                                                                          
  File "/cephfs/volumes/hpc_home/k2472719/e8dfa876-ccf0-46d2-94b2-0f78526b0989/hpc_stats.py", line 271, in process_job                                                              
  stats[collate_key]["sum_job_cpu_eff"] += cpu_eff                                                                                                                                  
  TypeError: unsupported operand type(s) for +=: 'float' and 'decimal.Decimal'                                                                                                      
  And this one: k2472719@erc-hpc-login1:~$ python3 query_job_states.py                                                                                                              
  === JOB STATES IN DATABASE (Jan 2025) ===                                                                                                                                         
  state_code, count                                                                                                                                                                 
  3, 385061                                                                                                                                                                         
  5, 36545                                                                                                                                                                          
  4, 24609                                                                                                                                                                          
  6, 5383                                                                                                                                                                           
  8, 522                                                                                                                                                                            
  7, 215                                                                                                                                                                            
  0, 1                                                                                                                                                                              
                                                                                                                                                                                    
  To find what each code means, run:                                                                                                                                                
  sacct -j <job_id> -o JobID,State                                                                                                                                                  
  for a job with that state, then compare with the code above.                                                                                                                      

● Good data from the job states query. The codes match standard Slurm:
  - 3 = COMPLETED (385,061)
  - 5 = FAILED (36,545)
  - 4 = CANCELLED (24,609)
  - 6 = TIMEOUT (5,383)
  - 8 = PREEMPTED (522) - I should add this to finished states
  - 7 = NODE_FAIL (215)

  The error in hpc_stats.py is because MySQL returns Decimal objects, not floats. Let me fix that:

● Update(hpc_stats.py)
  ⎿  Added 2 lines, removed 1 line                                                                                                                                               
      41  JOB_STATE_TIMEOUT = 6
      42  JOB_STATE_CANCELLED = 4
      43  JOB_STATE_NODE_FAIL = 7
      44 +JOB_STATE_PREEMPTED = 8                                                                                                                                                
      45  
      46  # States considered "finished" (job ran and ended)
      47  FINISHED_STATES = {JOB_STATE_COMPLETED, JOB_STATE_FAILED, JOB_STATE_TIMEOUT,
      47 -                   JOB_STATE_CANCELLED, JOB_STATE_NODE_FAIL}                                                                                                           
      48 +                   JOB_STATE_CANCELLED, JOB_STATE_NODE_FAIL, JOB_STATE_PREEMPTED}                                                                                      
      49  
      50  # States considered "successful"
      51  SUCCESS_STATES = {JOB_STATE_COMPLETED}

● Update(hpc_stats.py)
  ⎿  Added 7 lines                                                                                                                                                               
      225       timelimit, nodes_alloc, total_cpu_sec, total_cpu_usec,
      226       tres_usage_max) = row
      227  
      228 +    # Convert Decimal types to float (MySQL returns Decimal for aggregates)                                                                                           
      229 +    time_submit = float(time_submit) if time_submit else 0                                                                                                            
      230 +    time_start = float(time_start) if time_start else 0                                                                                                               
      231 +    time_end = float(time_end) if time_end else 0                                                                                                                     
      232 +    total_cpu_sec = float(total_cpu_sec) if total_cpu_sec else 0                                                                                                      
      233 +    total_cpu_usec = float(total_cpu_usec) if total_cpu_usec else 0                                                                                                   
      234 +                                                                                                                                                                      
      235      # Calculate derived values
      236      elapsed = time_end - time_start if time_end and time_start else 0
      237      wait_time = time_start - time_submit if time_start and time_submit else 0

● Fixed. I added PREEMPTED to finished states and converted Decimal types to float.

  Try running it again:

  python3 hpc_stats.py --collate_by st=faculty --collate_by none --since 202
